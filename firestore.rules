rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to validate version increment (prevent stale overwrites)
    function isValidVersion() {
      return !resource.data.keys().hasAny(['version']) ||
             !request.resource.data.keys().hasAny(['version']) ||
             request.resource.data.version >= resource.data.version;
    }
    
    // Helper function to validate updatedAt timestamp
    function hasValidTimestamp() {
      return !resource.data.keys().hasAny(['updatedAt']) ||
             request.resource.data.updatedAt is timestamp;
    }
    
    // User data collections
    match /users/{userId}/{collection}/{document} {
      // Allow read if user owns the data
      allow read: if isOwner(userId);

      // Allow create if user owns the data
      allow create: if isOwner(userId);

      // Allow update with version and timestamp validation
      allow update: if isOwner(userId)
                    && isValidVersion()
                    && hasValidTimestamp();

      // Allow delete if user owns the data (no validation needed for delete)
      allow delete: if isOwner(userId);
    }

    // Visa requirements - read-only for all users
    match /visa_requirements/{document} {
      allow read: if true;
      allow write: if false; // Only cloud functions can write
    }

    // Visa data metadata - read-only for all users
    match /visa_data/{document} {
      allow read: if true;
      allow write: if false; // Only cloud functions can write
    }

    // Visa update errors - read-only for authenticated users (for debugging)
    match /visa_update_errors/{document} {
      allow read: if isAuthenticated();
      allow write: if false; // Only cloud functions can write
    }

    // Photo Feedback Sessions - Creation requires authentication, voting is open
    match /photoSessions/{sessionId} {
      // Anyone can read sessions (for voting)
      allow read: if true;

      // Only authenticated users can create sessions and must set themselves as owner
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;

      // No updates or deletes allowed (sessions are immutable)
      allow update, delete: if false;

      // Votes subcollection - anonymous voting allowed
      match /votes/{voteId} {
        // Anyone can read votes (for results)
        allow read: if true;

        // Anyone can create votes (for voting)
        allow create: if true;

        // No updates or deletes (votes are final)
        allow update, delete: if false;
      }
    }

    // Photo Battles - long-lived Elo sessions
    match /photoBattles/{userId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if (
        (isAuthenticated() && request.auth.uid == resource.data.ownerId) ||
        (
          request.resource.data.ownerId == resource.data.ownerId &&
          request.resource.data.secretKey == resource.data.secretKey &&
          request.resource.data.createdAt == resource.data.createdAt &&
          request.resource.data.photos is list &&
          request.resource.data.photos.size() == resource.data.photos.size()
        )
      );
      allow delete: if false;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
