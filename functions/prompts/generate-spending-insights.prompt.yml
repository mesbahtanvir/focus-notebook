name: Generate Spending Insights
description: Analyzes monthly spending data to generate actionable insights, warnings, subscription detection, budget suggestions, and clarifying questions

model: anthropic/claude-3-5-sonnet-20241022

modelParameters:
  temperature: 0
  max_tokens: 2000

messages:
  - role: system
    content: |
      You are a precise personal-finance analyst. Use only provided aggregates and notable transactions.
      Do not invent numbers. If data is missing, state what's missing.
      Produce 3–6 headlineInsights; spendWarnings for categories with >30% MoM increase; list newSubscriptions exactly as provided; suggest 2–4 actionable budgetSuggestions; ask 1–3 clarifying questions.
      Return valid JSON only conforming to the schema.

  - role: user
    content: |
      Analyze this spending data for {{month}}:

      ## Summary
      - Total Outflow: ${{outflow}}
      - Total Inflow: ${{inflow}}
      - Net Cashflow: ${{netCashflow}}
      - Transaction Count: {{transactionCount}}

      ## Category Breakdown
      {{categoryBreakdown}}

      ## Top Merchants
      {{topMerchants}}

      ## Anomalies (vs Previous Month)
      {{anomalies}}

      ## Notable Transactions
      {{notableTransactions}}

      Return a JSON object with this exact structure:
      {
        "month": "YYYY-MM",
        "headlineInsights": ["string", "string", ...],
        "spendWarnings": [{"category": "string", "deltaPct": number, "explanation": "string"}, ...],
        "newSubscriptions": [{"merchant": "string", "amount": number, "firstSeen": "YYYY-MM-DD"}, ...],
        "budgetSuggestions": {
          "notes": "string",
          "actions": [{"title": "string", "impact": "string"}, ...]
        },
        "questionsForUser": ["string", ...]
      }

testData:
  - month: "2025-11"
    outflow: "3542.75"
    inflow: "5200.00"
    netCashflow: "1657.25"
    transactionCount: "142"
    categoryBreakdown: |
      - Food & Drink: $892.50 (25.2%, 45 txns)
      - Transport: $456.30 (12.9%, 18 txns)
      - Shopping: $678.90 (19.2%, 23 txns)
      - Entertainment: $234.50 (6.6%, 12 txns)
      - Utilities: $425.00 (12.0%, 8 txns)
      - Fitness: $185.00 (5.2%, 6 txns)
      - Other: $670.55 (18.9%, 30 txns)
    topMerchants: |
      - Whole Foods: $342.80 (12 txns)
      - Shell: $245.60 (8 txns)
      - Amazon: $567.90 (15 txns)
      - Netflix: $15.99 (1 txns)
      - Spotify: $10.99 (1 txns)
      - LA Fitness: $45.00 (1 txns)
      - Starbucks: $156.40 (18 txns)
    anomalies: |
      - Shopping: +42% Significant increase in online shopping
      - Entertainment: +15% Slight increase in entertainment spending
    notableTransactions: |
      - Amazon: $234.50 on 2025-11-05 (Shopping)
      - Whole Foods: $125.80 on 2025-11-12 (Food & Drink)
      - Shell: $65.00 on 2025-11-08 (Transport)
      - Apple Store: $299.00 on 2025-11-15 (Shopping)
    expected: |
      {
        "month": "2025-11",
        "headlineInsights": [
          "Net positive cashflow of $1,657.25 this month",
          "Food & Drink is your largest category at 25.2% of spending",
          "Shopping spending increased by 42% compared to last month",
          "You're averaging $24.95 per day in spending",
          "Three active subscriptions detected: Netflix, Spotify, LA Fitness"
        ],
        "spendWarnings": [
          {
            "category": "Shopping",
            "deltaPct": 42,
            "explanation": "Significant increase driven by Amazon and Apple Store purchases"
          }
        ],
        "newSubscriptions": [
          {
            "merchant": "Netflix",
            "amount": 15.99,
            "firstSeen": "2025-11-01"
          },
          {
            "merchant": "Spotify",
            "amount": 10.99,
            "firstSeen": "2025-11-01"
          }
        ],
        "budgetSuggestions": {
          "notes": "Consider reducing discretionary spending in shopping and coffee purchases",
          "actions": [
            {
              "title": "Set a monthly shopping budget of $500",
              "impact": "Could save ~$179 per month"
            },
            {
              "title": "Reduce Starbucks visits to 2-3 times per week",
              "impact": "Could save ~$100 per month"
            },
            {
              "title": "Review and consolidate streaming subscriptions",
              "impact": "Potential savings of $10-20 per month"
            }
          ]
        },
        "questionsForUser": [
          "Was the Apple Store purchase planned or impulse?",
          "Are you using all your active subscriptions regularly?",
          "Would you like to set spending limits for specific categories?"
        ]
      }

evaluators:
  - name: Response is valid JSON
    string:
      matchesRegex: '^\{.*\}$'

  - name: Contains month field
    string:
      contains: '"month":'

  - name: Contains headlineInsights array
    string:
      contains: '"headlineInsights":'

  - name: Contains spendWarnings array
    string:
      contains: '"spendWarnings":'

  - name: Contains newSubscriptions array
    string:
      contains: '"newSubscriptions":'

  - name: Contains budgetSuggestions object
    string:
      contains: '"budgetSuggestions":'

  - name: Contains questionsForUser array
    string:
      contains: '"questionsForUser":'

  - name: budgetSuggestions has notes and actions
    string:
      matchesRegex: '"budgetSuggestions":\s*\{[^}]*"notes":[^}]*"actions":'

  - name: spendWarnings have required fields
    string:
      matchesRegex: '"spendWarnings":\s*\[[^\]]*("category"|"deltaPct"|"explanation")'
