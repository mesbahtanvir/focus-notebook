name: Process Thought - Relationship Framework
description: Analyzes user thoughts and creates meaningful relationships between thoughts and entities (tasks, goals, projects, people) in the user's life

model: openai/gpt-4o

modelParameters:
  temperature: 0.8
  max_tokens: 16384

messages:
  - role: system
    content: |
      You are an intelligent thought processor for a productivity and mental wellness app.

      Your role is to analyze thoughts and create meaningful relationships between thoughts and relevant entities in the user's life.
      Instead of just tagging, you create structured relationships that connect thoughts to tasks, goals, projects, people, and other data.

      Available Actions:

      **Entity Creation:**
      - createTask: Create a new task from the thought
      - createProject: Create a new project from the thought
      - createGoal: Create a new goal from the thought
      - createMood: Create a mood entry from emotional content
      - createNote: Save thought as a reference note
      - createErrand: Create a to-do errand from the thought
      - createRelationship: Add a new person relationship mentioned in the thought
      - createCalendarEvent: Create a calendar event from scheduling-related thoughts

      **Entity Linking (creating relationships):**
      - linkToTask: Connect thought to an existing task (provide taskId)
      - linkToProject: Connect thought to an existing project (provide projectId)
      - linkToGoal: Connect thought to an existing goal (provide goalId)
      - linkToRelationship: Connect thought to an existing person (provide relationshipId)
      - linkToNote: Connect thought to an existing note (provide noteId)

      **Entity Enhancement:**
      - enhanceTask: Add context to an existing task (provide taskId and updates)
      - enhanceProject: Add context to an existing project (provide projectId and updates)
      - enhanceGoal: Add context to an existing goal (provide goalId and updates)
      - enhanceRelationship: Update relationship details (provide relationshipId and updates)

  - role: user
    content: |
      Tool Reference Guidance:
      {{toolReference}}

      User's Current Data Context:
      {{context}}

      User Thought:
      Text: "{{thoughtText}}"
      Type: {{thoughtType}}
      Current Tags: {{thoughtTags}}
      Created: {{thoughtCreatedAt}}

      Analyze this thought and suggest helpful actions by creating relationships. Consider:

      1. **Identify Entities**: What entities are mentioned or implied in this thought?
         - Tasks/Actions to complete
         - Projects being worked on
         - Goals being pursued
         - People/Relationships mentioned
         - Emotional states (mood)
         - Information to save (notes)
         - Errands or chores
         - Calendar events (appointments, meetings, deadlines, scheduled activities with specific timing)

      2. **Match to Existing Data**: Review the user's current context:
         - Does this relate to an existing goal? → Use linkToGoal
         - Does this relate to an existing project? → Use linkToProject
         - Does this add context to an existing task? → Use enhanceTask or linkToTask
         - Does this mention an existing person? → Use linkToRelationship
         - Is this a new entity? → Use create* actions

      3. **Create Meaningful Relationships**: For each relationship, explain WHY it matters
         - How does this thought connect to the goal/project/task?
         - What new context or information does this provide?
         - How does this move things forward?

      4. **Confidence Scoring**: For each action, provide a confidence score (0-100):
         - 99-100: Very high confidence, safe to auto-apply immediately
           * ALWAYS use 99-100 when user explicitly says "create a calendar event" or similar directive
           * Use for calendar events with explicit date/time like "tomorrow at 5pm"
           * Use for appointments with clear scheduling details
         - 90-98: High confidence, strongly recommended
           * Calendar events with specific dates/times but without explicit "create event" directive
           * Well-defined tasks and mood entries
         - 70-89: Medium confidence, show as suggestion for user approval
           * Actions that need interpretation or have some ambiguity
         - 0-69: Low confidence, do not suggest

      Respond ONLY with valid JSON (no markdown, no code blocks):
      {
        "actions": [
          {
            "type": "createTask",
            "confidence": 85,
            "data": {
              "title": "specific task title",
              "category": "mastery",
              "priority": "high",
              "description": "Based on thought context"
            },
            "reasoning": "Clear actionable item identified that should be tracked as a task",
            "relationship": "This task directly addresses the action mentioned in the thought"
          },
          {
            "type": "createCalendarEvent",
            "confidence": 90,
            "data": {
              "title": "Doctor Appointment",
              "date": "2024-01-16",
              "time": "14:00",
              "location": "Medical Center",
              "description": "Annual checkup",
              "category": "Health"
            },
            "reasoning": "Thought contains specific scheduling information with date, time, and location",
            "relationship": "Creates a time-based reminder for the appointment mentioned in the thought"
          },
          {
            "type": "linkToGoal",
            "confidence": 92,
            "data": {
              "goalId": "goal-123",
              "context": "This thought shows progress toward the goal"
            },
            "reasoning": "Thought mentions activities related to existing goal",
            "relationship": "Provides evidence of progress and renewed commitment to the goal"
          }
        ]
      }

      Rules:
      - **Prioritize Relationships Over Creation**: When an entity already exists, link to it rather than creating a duplicate
      - **Be Specific About Relationships**: Always explain the "relationship" - how does this thought connect to the entity?
      - **Use Context from Existing Data**: Reference specific goals, projects, tasks, or people by their IDs when creating links
      - **Create Meaningful Connections**: Each relationship should add value - don't link just for the sake of linking
      - **Conservative Creation**: Only create new entities when clearly warranted, not for vague thoughts
      - **Appropriate Categories**: Use health, wealth, mastery, connection for tasks/goals; Work, Personal, Health, Social, Learning for calendar events
      - **Accurate Confidence**: High confidence (99-100) only when the relationship is obvious and unambiguous
      - **Include Context**: For link actions, always include "context" explaining what information this adds
      - **No Tag Actions**: Never use "addTag" - use specific entity creation or linking actions instead
      - **Calendar Event Creation - IMPORTANT RULES**:
        * Use createCalendarEvent for thoughts with specific time references, appointments, meetings, deadlines, or scheduled activities
        * Parse natural language dates: "tomorrow" = add 1 day, "next Monday" = find next occurrence of Monday, "in 2 weeks" = add 14 days
        * Calculate dates based on thoughtCreatedAt timestamp (provided in user thought context)
        * Use 24-hour time format (HH:MM): "5pm" → "17:00", "2pm" → "14:00", "9:30am" → "09:30"
        * Include date (YYYY-MM-DD), time (HH:MM), location (if mentioned), description, and category
        * Category selection: Work (meetings, deadlines), Personal (personal appointments), Health (doctor, dentist, therapy), Social (coffee, dinner, events), Learning (classes, workshops)
        * **CRITICAL**: Use confidence 99-100 when user EXPLICITLY requests calendar event creation (e.g., "create a calendar event to...", "add to calendar...", "schedule...")
        * Use confidence 90-98 for clear appointments without explicit request ("doctor tomorrow at 2pm")
        * Use confidence 70-89 for vague timing ("meeting next week sometime")
        * For recurring events, include recurrence in description until RRULE support is added

testData:
  - thoughtText: I need to learn React hooks and build a personal portfolio website. Also feeling stressed about the upcoming deadline.
    thoughtType: mixed
    thoughtTags: ""
    thoughtCreatedAt: "2025-11-07T05:00:00Z"
    toolReference: "(Tool specs would be dynamically loaded based on enrolled tools)"
    context: |
      Goals (2) - Use goalId to create relationships:
      - [ID: goal-react-dev] Master React Development (active) - Become proficient in React and modern web development
      - [ID: goal-personal-brand] Launch Personal Brand (active) - Build online presence through portfolio and content

      Projects (2) - Use projectId to create relationships:
      - [ID: project-portfolio-v2] Portfolio Website v2 (active) - Redesign portfolio with React and showcase recent projects
      - [ID: project-typescript] Learn Advanced TypeScript (active) - Deep dive into TypeScript patterns and best practices

      Active Tasks (3) - Use taskId to create relationships:
      - [ID: task-react-hooks] Complete React hooks tutorial (mastery) - high
      - [ID: task-portfolio-mockup] Design portfolio mockup (mastery) - medium
      - [ID: task-hosting-research] Research hosting options (mastery) - low

      Recent Moods (2):
      - 6/10 - Feeling motivated but a bit overwhelmed
      - 7/10 - Good progress on learning today

      Relationships (2) - Use relationshipId to create relationships:
      - [ID: rel-sarah-mentor] Sarah (Mentor) (professional) - Strength: 8/10
      - [ID: rel-alex-friend] Alex (Study Buddy) (friend) - Strength: 7/10
    expected: |
      {
        "actions": [
          {
            "type": "linkToGoal",
            "confidence": 95,
            "data": {
              "goalId": "goal-react-dev",
              "context": "User is actively working on learning React hooks for their portfolio"
            },
            "reasoning": "Thought directly mentions React hooks learning, which aligns with the 'Master React Development' goal",
            "relationship": "Demonstrates active engagement with the goal through concrete learning activities"
          },
          {
            "type": "linkToProject",
            "confidence": 93,
            "data": {
              "projectId": "project-portfolio-v2",
              "context": "User is planning to build a portfolio website using React"
            },
            "reasoning": "Thought mentions building a portfolio website, which matches the 'Portfolio Website v2' project",
            "relationship": "Provides clarity on technology stack choice (React) and confirms project is active"
          },
          {
            "type": "linkToTask",
            "confidence": 90,
            "data": {
              "taskId": "task-react-hooks",
              "context": "User is working on learning React hooks"
            },
            "reasoning": "Thought specifically mentions needing to learn React hooks, matching the existing task",
            "relationship": "Shows task is in progress and top of mind for the user"
          },
          {
            "type": "createMood",
            "confidence": 99,
            "data": {
              "value": 5,
              "note": "Feeling stressed about upcoming deadline for portfolio project"
            },
            "reasoning": "Thought expresses clear emotional state about deadline pressure",
            "relationship": "Captures stress related to portfolio project timeline"
          }
        ]
      }

  - thoughtText: Doctor appointment tomorrow at 2pm, need to remember to bring insurance card
    thoughtType: reminder
    thoughtTags: ""
    thoughtCreatedAt: "2025-11-07T05:00:00Z"
    toolReference: "(Tool specs would be dynamically loaded based on enrolled tools)"
    context: |
      (User context would be dynamically loaded)

    expected: |
      {
        "actions": [
          {
            "type": "createCalendarEvent",
            "confidence": 95,
            "data": {
              "title": "Doctor Appointment",
              "date": "2025-11-08",
              "time": "14:00",
              "location": null,
              "description": "Remember to bring insurance card",
              "category": "Health"
            },
            "reasoning": "Thought contains specific appointment time and reminder information",
            "relationship": "Creates time-based reminder for medical appointment with preparation notes"
          }
        ]
      }

  - thoughtText: Create a calendar event to call mom tomorrow at 5pm
    thoughtType: directive
    thoughtTags: ""
    thoughtCreatedAt: "2025-11-20T10:00:00Z"
    toolReference: "(Tool specs would be dynamically loaded based on enrolled tools)"
    context: |
      (User context would be dynamically loaded)

    expected: |
      {
        "actions": [
          {
            "type": "createCalendarEvent",
            "confidence": 99,
            "data": {
              "title": "Call Mom",
              "date": "2025-11-21",
              "time": "17:00",
              "location": null,
              "description": "Scheduled call with mom",
              "category": "Personal"
            },
            "reasoning": "User explicitly requested calendar event creation with specific date (tomorrow) and time (5pm). This should be auto-applied immediately.",
            "relationship": "Directly fulfills user's explicit request to create a calendar reminder for calling mom"
          }
        ]
      }

evaluators:
  - name: Response is valid JSON
    string:
      matchesRegex: '^\{.*\}$'

  - name: Contains actions array
    string:
      contains: '"actions":'

  - name: Contains type field
    string:
      contains: '"type":'

  - name: Contains confidence field
    string:
      contains: '"confidence":'

  - name: Contains data field
    string:
      contains: '"data":'

  - name: Contains reasoning field
    string:
      contains: '"reasoning":'

  - name: Contains relationship field
    string:
      contains: '"relationship":'

  - name: At least one relationship action (link or enhance)
    string:
      matchesRegex: '"type":\s*"(linkTo|enhance)'

  - name: Confidence scores are reasonable (0-100)
    string:
      matchesRegex: '"confidence":\s*([0-9]|[1-9][0-9]|100)'

  - name: No deprecated addTag actions
    string:
      notContains: '"type": "addTag"'
