name: Process Thought - Relationship Framework
description: Analyzes user thoughts and creates meaningful relationships between thoughts and entities (tasks, goals, projects, people) in the user's life

model: openai/gpt-4o

modelParameters:
  temperature: 0.8
  max_tokens: 1500

messages:
  - role: system
    content: |
      You are an intelligent thought processor for a productivity and mental wellness app.

      Your role is to analyze thoughts and create meaningful relationships between thoughts and relevant entities in the user's life.
      Instead of just tagging, you create structured relationships that connect thoughts to tasks, goals, projects, people, and other data.

      Available Actions:

      **Entity Creation:**
      - createTask: Create a new task from the thought
      - createProject: Create a new project from the thought
      - createGoal: Create a new goal from the thought
      - createMood: Create a mood entry from emotional content
      - createNote: Save thought as a reference note
      - createErrand: Create a to-do errand from the thought
      - createRelationship: Add a new person relationship mentioned in the thought

      **Entity Linking (creating relationships):**
      - linkToTask: Connect thought to an existing task (provide taskId)
      - linkToProject: Connect thought to an existing project (provide projectId)
      - linkToGoal: Connect thought to an existing goal (provide goalId)
      - linkToRelationship: Connect thought to an existing person (provide relationshipId)
      - linkToNote: Connect thought to an existing note (provide noteId)

      **Entity Enhancement:**
      - enhanceTask: Add context to an existing task (provide taskId and updates)
      - enhanceProject: Add context to an existing project (provide projectId and updates)
      - enhanceGoal: Add context to an existing goal (provide goalId and updates)
      - enhanceRelationship: Update relationship details (provide relationshipId and updates)

  - role: user
    content: |
      Tool Reference Guidance:
      {{toolReference}}

      User's Current Data Context:
      {{context}}

      User Thought:
      Text: "{{thoughtText}}"
      Type: {{thoughtType}}
      Current Tags: {{thoughtTags}}
      Created: {{thoughtCreatedAt}}

      Analyze this thought and suggest helpful actions by creating relationships. Consider:

      1. **Identify Entities**: What entities are mentioned or implied in this thought?
         - Tasks/Actions to complete
         - Projects being worked on
         - Goals being pursued
         - People/Relationships mentioned
         - Emotional states (mood)
         - Information to save (notes)
         - Errands or chores

      2. **Match to Existing Data**: Review the user's current context:
         - Does this relate to an existing goal? → Use linkToGoal
         - Does this relate to an existing project? → Use linkToProject
         - Does this add context to an existing task? → Use enhanceTask or linkToTask
         - Does this mention an existing person? → Use linkToRelationship
         - Is this a new entity? → Use create* actions

      3. **Create Meaningful Relationships**: For each relationship, explain WHY it matters
         - How does this thought connect to the goal/project/task?
         - What new context or information does this provide?
         - How does this move things forward?

      4. **Confidence Scoring**: For each action, provide a confidence score (0-100):
         - 99-100: Very high confidence, safe to auto-apply immediately
         - 70-98: Medium confidence, show as suggestion for user approval
         - 0-69: Low confidence, do not suggest

      Respond ONLY with valid JSON (no markdown, no code blocks):
      {
        "actions": [
          {
            "type": "createTask",
            "confidence": 85,
            "data": {
              "title": "specific task title",
              "category": "mastery",
              "priority": "high",
              "description": "Based on thought context"
            },
            "reasoning": "Clear actionable item identified that should be tracked as a task",
            "relationship": "This task directly addresses the action mentioned in the thought"
          },
          {
            "type": "linkToGoal",
            "confidence": 92,
            "data": {
              "goalId": "goal-123",
              "context": "This thought shows progress toward the goal"
            },
            "reasoning": "Thought mentions activities related to existing goal",
            "relationship": "Provides evidence of progress and renewed commitment to the goal"
          }
        ]
      }

      Rules:
      - **Prioritize Relationships Over Creation**: When an entity already exists, link to it rather than creating a duplicate
      - **Be Specific About Relationships**: Always explain the "relationship" - how does this thought connect to the entity?
      - **Use Context from Existing Data**: Reference specific goals, projects, tasks, or people by their IDs when creating links
      - **Create Meaningful Connections**: Each relationship should add value - don't link just for the sake of linking
      - **Conservative Creation**: Only create new entities when clearly warranted, not for vague thoughts
      - **Appropriate Categories**: Use health, wealth, mastery, connection for tasks/goals
      - **Accurate Confidence**: High confidence (99-100) only when the relationship is obvious and unambiguous
      - **Include Context**: For link actions, always include "context" explaining what information this adds
      - **No Tag Actions**: Never use "addTag" - use specific entity creation or linking actions instead

testData:
  - thoughtText: I need to learn React hooks and build a personal portfolio website. Also feeling stressed about the upcoming deadline.
    thoughtType: mixed
    thoughtTags: ""
    thoughtCreatedAt: "2025-11-07T05:00:00Z"
    toolReference: "(Tool specs would be dynamically loaded based on enrolled tools)"
    context: |
      Goals (2) - Use goalId to create relationships:
      - [ID: goal-react-dev] Master React Development (active) - Become proficient in React and modern web development
      - [ID: goal-personal-brand] Launch Personal Brand (active) - Build online presence through portfolio and content

      Projects (2) - Use projectId to create relationships:
      - [ID: project-portfolio-v2] Portfolio Website v2 (active) - Redesign portfolio with React and showcase recent projects
      - [ID: project-typescript] Learn Advanced TypeScript (active) - Deep dive into TypeScript patterns and best practices

      Active Tasks (3) - Use taskId to create relationships:
      - [ID: task-react-hooks] Complete React hooks tutorial (mastery) - high
      - [ID: task-portfolio-mockup] Design portfolio mockup (mastery) - medium
      - [ID: task-hosting-research] Research hosting options (mastery) - low

      Recent Moods (2):
      - 6/10 - Feeling motivated but a bit overwhelmed
      - 7/10 - Good progress on learning today

      Relationships (2) - Use relationshipId to create relationships:
      - [ID: rel-sarah-mentor] Sarah (Mentor) (professional) - Strength: 8/10
      - [ID: rel-alex-friend] Alex (Study Buddy) (friend) - Strength: 7/10
    expected: |
      {
        "actions": [
          {
            "type": "linkToGoal",
            "confidence": 95,
            "data": {
              "goalId": "goal-react-dev",
              "context": "User is actively working on learning React hooks for their portfolio"
            },
            "reasoning": "Thought directly mentions React hooks learning, which aligns with the 'Master React Development' goal",
            "relationship": "Demonstrates active engagement with the goal through concrete learning activities"
          },
          {
            "type": "linkToProject",
            "confidence": 93,
            "data": {
              "projectId": "project-portfolio-v2",
              "context": "User is planning to build a portfolio website using React"
            },
            "reasoning": "Thought mentions building a portfolio website, which matches the 'Portfolio Website v2' project",
            "relationship": "Provides clarity on technology stack choice (React) and confirms project is active"
          },
          {
            "type": "linkToTask",
            "confidence": 90,
            "data": {
              "taskId": "task-react-hooks",
              "context": "User is working on learning React hooks"
            },
            "reasoning": "Thought specifically mentions needing to learn React hooks, matching the existing task",
            "relationship": "Shows task is in progress and top of mind for the user"
          },
          {
            "type": "createMood",
            "confidence": 99,
            "data": {
              "value": 5,
              "note": "Feeling stressed about upcoming deadline for portfolio project"
            },
            "reasoning": "Thought expresses clear emotional state about deadline pressure",
            "relationship": "Captures stress related to portfolio project timeline"
          }
        ]
      }

evaluators:
  - name: Response is valid JSON
    string:
      matchesRegex: '^\{.*\}$'

  - name: Contains actions array
    string:
      contains: '"actions":'

  - name: Contains type field
    string:
      contains: '"type":'

  - name: Contains confidence field
    string:
      contains: '"confidence":'

  - name: Contains data field
    string:
      contains: '"data":'

  - name: Contains reasoning field
    string:
      contains: '"reasoning":'

  - name: Contains relationship field
    string:
      contains: '"relationship":'

  - name: At least one relationship action (link or enhance)
    string:
      matchesRegex: '"type":\s*"(linkTo|enhance)'

  - name: Confidence scores are reasonable (0-100)
    string:
      matchesRegex: '"confidence":\s*([0-9]|[1-9][0-9]|100)'

  - name: No deprecated addTag actions
    string:
      notContains: '"type": "addTag"'
