name: Deploy to Production

# This workflow handles deployment ONLY
# It runs after CI validation passes on the main branch
# No deployment ever happens from PRs

on:
  workflow_run:
    workflows: ["CI - Validation & Testing"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check_ci_success:
    name: Check CI Status
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      deploy: ${{ steps.check.outputs.deploy }}
    steps:
      - name: Check if deployment should proceed
        id: check
        run: |
          echo "CI workflow completed successfully"
          echo "deploy=true" >> $GITHUB_OUTPUT

  deploy_functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    needs: check_ci_success
    if: needs.check_ci_success.outputs.deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: npm
          cache-dependency-path: backend/functions/package-lock.json

      - name: Install dependencies
        run: |
          cd backend/functions
          npm ci

      - name: Generate environment file
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test-mock-key-12345678901234567890' }}
          STRIPE_SECRET: ${{ secrets.STRIPE_SECRET || 'sk_test_placeholder' }}
          STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID || 'price_test_placeholder' }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET || 'whsec_test_placeholder' }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL || 'https://focus.yourthoughts.ca' }}
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY || 'demo' }}
        run: |
          python - <<'PY'
          import os, pathlib

          env_path = pathlib.Path('backend/functions/.env')
          env_path.write_text('\n'.join([
              f"OPENAI_API_KEY={os.environ['OPENAI_KEY']}",
              f"STRIPE_SECRET={os.environ['STRIPE_SECRET']}",
              f"STRIPE_PRICE_ID={os.environ['STRIPE_PRICE_ID']}",
              f"STRIPE_WEBHOOK_SECRET={os.environ['STRIPE_WEBHOOK_SECRET']}",
              f"APP_BASE_URL={os.environ['APP_BASE_URL']}",
              f"ALPHA_VANTAGE_API_KEY={os.environ['ALPHA_VANTAGE_KEY']}",
          ]) + '\n')
          PY

      - name: Build functions
        run: |
          cd backend/functions
          npm run build

      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions --config infra/firebase/firebase.json
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}

      - name: Comment deployment success on related PRs
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            const commitSha = context.sha;
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commitSha,
            });

            for (const pr of prs) {
              await github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `✅ Cloud Functions deployed successfully to production for commit ${commitSha.substring(0, 7)}`
              });
            }

      - name: Notify deployment failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const commitSha = context.sha;
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commitSha,
            });

            for (const pr of prs) {
              await github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `❌ Cloud Functions deployment failed for commit ${commitSha.substring(0, 7)}. Check the [deployment workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
              });
            }
